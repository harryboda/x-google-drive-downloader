# v2.0 å¼€å‘è®¡åˆ’ï¼šç”¨æˆ·ä½“éªŒä¼˜åŒ–ç‰ˆæœ¬

## ğŸ¯ æ ¸å¿ƒç›®æ ‡

å°†åº”ç”¨ä»"å¼€å‘è€…å·¥å…·"å‡çº§ä¸º"ç”¨æˆ·å‹å¥½çš„ç‹¬ç«‹åº”ç”¨"

### ç”¨æˆ·ä½“éªŒç›®æ ‡
- **ä¸€æ¬¡é…ç½®ï¼ŒæŒä¹…ä½¿ç”¨**ï¼šç”¨æˆ·é¦–æ¬¡é…ç½®åï¼Œæ— éœ€é‡å¤è®¾ç½®
- **å³å¼€å³ç”¨**ï¼šåŒå‡»åº”ç”¨å›¾æ ‡å³å¯å¯åŠ¨ï¼Œæ— éœ€å‘½ä»¤è¡Œ
- **ç‹¬ç«‹åˆ†å‘**ï¼šå¯ä»¥æ‰“åŒ…åˆ†äº«ç»™å…¶ä»–ç”¨æˆ·ç›´æ¥ä½¿ç”¨

## ğŸ” å½“å‰é—®é¢˜æ·±åº¦åˆ†æ

### 1. Secure Storage æƒé™é—®é¢˜

**é”™è¯¯ç°è±¡**:
```
flutter: Failed to save auth to secure storage: PlatformException(Unexpected security result code, Code: -34018, Message: A required entitlement isn't present., -34018, null)
```

**æ ¹æœ¬åŸå› **:
- macOSé”™è¯¯ç  -34018 = `errSecMissingEntitlement`
- å½“å‰ entitlements ç¼ºå°‘ keychain è®¿é—®æƒé™
- ä¹‹å‰ä¸ºäº†é¿å…ç­¾åé—®é¢˜ç§»é™¤äº† keychain æƒé™

**å½±å“**:
- æ— æ³•ä¿å­˜OAuthä»¤ç‰Œ
- æ¯æ¬¡å¯åŠ¨éƒ½éœ€è¦é‡æ–°è®¤è¯
- ç”¨æˆ·ä½“éªŒæå·®

### 2. OAuth é…ç½®é—®é¢˜

**å½“å‰æ¨¡å¼**:
```bash
--dart-define=GOOGLE_CLIENT_ID="$PROD_CLIENT_ID" \
--dart-define=GOOGLE_CLIENT_SECRET="$PROD_CLIENT_SECRET"
```

**é—®é¢˜**:
- éœ€è¦ä¿®æ”¹è„šæœ¬é…ç½®
- æ— æ³•ç‹¬ç«‹åˆ†å‘
- ç”¨æˆ·æ— æ³•è‡ªå·±é…ç½®OAuth

### 3. åº”ç”¨åˆ†å‘é—®é¢˜

**å½“å‰çŠ¶æ€**:
- éœ€è¦Flutterå¼€å‘ç¯å¢ƒ
- å¿…é¡»é€šè¿‡è„šæœ¬å¯åŠ¨
- æ— æ³•ä½œä¸ºç‹¬ç«‹.appåˆ†å‘

## ğŸ“‹ v2.0 æŠ€æœ¯è§£å†³æ–¹æ¡ˆ

### Phase 1: ä¿®å¤è®¤è¯æŒä¹…åŒ– ğŸ”§

#### 1.1 ä¿®å¤ macOS Entitlements
```xml
<!-- æ·»åŠ  keychain è®¿é—®æƒé™ -->
<key>com.apple.security.keychain-access-groups</key>
<array>
    <string>$(AppIdentifierPrefix)com.yourcompany.gdrive-downloader</string>
</array>
```

#### 1.2 å®ç°å¤‡ç”¨å­˜å‚¨æ–¹æ¡ˆ
- **ä¸»è¦æ–¹æ¡ˆ**: ä¿®å¤ flutter_secure_storage
- **å¤‡ç”¨æ–¹æ¡ˆ**: ä½¿ç”¨åŠ å¯†çš„æœ¬åœ°æ–‡ä»¶å­˜å‚¨
- **å…œåº•æ–¹æ¡ˆ**: å†…å­˜ä¸­çš„ä¼šè¯ç¼“å­˜

```dart
class SafeAuthStorage {
  // å°è¯•secure storage
  // å¤±è´¥æ—¶å›é€€åˆ°åŠ å¯†æ–‡ä»¶
  // å†å¤±è´¥æ—¶ä½¿ç”¨ä¼šè¯ç¼“å­˜
}
```

### Phase 2: OAuthé…ç½®å†…ç½®åŒ– âš™ï¸

#### 2.1 é»˜è®¤OAuthé…ç½®
```dart
class AppConfig {
  // å†…ç½®é»˜è®¤çš„OAuthé…ç½®ï¼ˆå¼€å‘è€…è´¦å·ï¼‰
  static const String defaultClientId = "YOUR_GOOGLE_CLIENT_ID";
  static const String defaultClientSecret = "YOUR_GOOGLE_CLIENT_SECRET";
  
  // æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰é…ç½®
  static String? customClientId;
  static String? customClientSecret;
}
```

#### 2.2 åº”ç”¨å†…OAuthé…ç½®ç•Œé¢
```dart
class OAuthSettingsPage extends StatelessWidget {
  // è®©é«˜çº§ç”¨æˆ·å¯ä»¥é…ç½®è‡ªå·±çš„OAuthå‡­æ®
  // å¤§éƒ¨åˆ†ç”¨æˆ·ä½¿ç”¨é»˜è®¤é…ç½®
}
```

### Phase 3: ç‹¬ç«‹åº”ç”¨æ„å»º ğŸ“¦

#### 3.1 è‡ªç­¾åè¯ä¹¦ç”Ÿæˆ
```bash
# åˆ›å»ºè‡ªç­¾åè¯ä¹¦ç”¨äºå¼€å‘åˆ†å‘
security create-certificate \
  -k ~/Library/Keychains/login.keychain \
  -s "Google Drive Downloader" \
  -S ca \
  -Z sha256
```

#### 3.2 åº”ç”¨æ‰“åŒ…ä¼˜åŒ–
```bash
# æ„å»ºç‹¬ç«‹.appåŒ…
flutter build macos --release --split-debug-info=build/debug-info
```

#### 3.3 åˆ†å‘åŒ…åˆ›å»º
- åˆ›å»ºDMGå®‰è£…åŒ…
- åŒ…å«ä½¿ç”¨è¯´æ˜
- ä¸€é”®å®‰è£…ä½“éªŒ

### Phase 4: ç”¨æˆ·ä½“éªŒä¼˜åŒ– âœ¨

#### 4.1 å¯åŠ¨æµç¨‹ä¼˜åŒ–
```dart
class AppBootstrap {
  // 1. æ£€æŸ¥è®¤è¯çŠ¶æ€
  // 2. è‡ªåŠ¨è¿›å…¥ä¸»ç•Œé¢æˆ–å¼•å¯¼é…ç½®
  // 3. æ™ºèƒ½å¤„ç†å„ç§å¼‚å¸¸æƒ…å†µ
}
```

#### 4.2 æ™ºèƒ½é“¾æ¥å¤„ç†
```dart
class SmartLinkHandler {
  // 1. è‡ªåŠ¨æ£€æµ‹å‰ªè´´æ¿ä¸­çš„Google Driveé“¾æ¥
  // 2. æ”¯æŒæ‹–æ‹½é“¾æ¥åˆ°åº”ç”¨
  // 3. URL schemeæ”¯æŒï¼ˆgdrive://ï¼‰
}
```

## ğŸ› ï¸ å®ç°ä¼˜å…ˆçº§

### ä¼˜å…ˆçº§ 1 (å¿…é¡»è§£å†³)
1. **ä¿®å¤ Secure Storage æƒé™é—®é¢˜**
   - é‡æ–°é…ç½® entitlements
   - å®ç°å¤‡ç”¨å­˜å‚¨æ–¹æ¡ˆ
   - æµ‹è¯•è®¤è¯æŒä¹…åŒ–

### ä¼˜å…ˆçº§ 2 (ç”¨æˆ·ä½“éªŒå…³é”®)
2. **å†…ç½®OAuthé…ç½®**
   - ä½¿ç”¨å¼€å‘è€…çš„OAuthå‡­æ®ä½œä¸ºé»˜è®¤é…ç½®
   - ç§»é™¤å¯¹ç¯å¢ƒå˜é‡çš„ä¾èµ–
   - æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰é…ç½®ï¼ˆé«˜çº§é€‰é¡¹ï¼‰

### ä¼˜å…ˆçº§ 3 (åˆ†å‘å¿…éœ€)
3. **ç‹¬ç«‹åº”ç”¨æ„å»º**
   - é…ç½®åº”ç”¨ç­¾å
   - æ„å»ºå¯åˆ†å‘çš„.appåŒ…
   - åˆ›å»ºå®‰è£…è¯´æ˜

### ä¼˜å…ˆçº§ 4 (ä½“éªŒä¼˜åŒ–)
4. **ç”¨æˆ·ä½“éªŒæå‡**
   - å¯åŠ¨æµç¨‹ä¼˜åŒ–
   - æ™ºèƒ½é“¾æ¥å¤„ç†
   - é”™è¯¯å¤„ç†æ”¹è¿›

## ğŸ“Š æˆåŠŸæŒ‡æ ‡

### æŠ€æœ¯æŒ‡æ ‡
- âœ… è®¤è¯æˆåŠŸç¼“å­˜ç‡ > 95%
- âœ… åº”ç”¨å¯åŠ¨æˆåŠŸç‡ > 99%
- âœ… ç‹¬ç«‹å®‰è£…æˆåŠŸç‡ > 90%

### ç”¨æˆ·ä½“éªŒæŒ‡æ ‡
- âœ… é¦–æ¬¡ä½¿ç”¨é…ç½®æ—¶é—´ < 2åˆ†é’Ÿ
- âœ… æ—¥å¸¸ä½¿ç”¨å¯åŠ¨æ—¶é—´ < 5ç§’
- âœ… é›¶å‘½ä»¤è¡Œä¾èµ–

## ğŸš€ å¼€å‘é‡Œç¨‹ç¢‘

### Milestone 1: è®¤è¯ä¿®å¤ (Week 1)
- ä¿®å¤secure storageæƒé™
- å®ç°è®¤è¯æŒä¹…åŒ–
- æµ‹è¯•å¤šæ¬¡å¯åŠ¨å…ç™»å½•

### Milestone 2: é…ç½®å†…ç½® (Week 1-2)  
- å†…ç½®OAuthé…ç½®
- ç§»é™¤è„šæœ¬ä¾èµ–
- å®ç°åº”ç”¨å†…é…ç½®é€‰é¡¹

### Milestone 3: ç‹¬ç«‹æ„å»º (Week 2)
- é…ç½®åº”ç”¨ç­¾å
- æ„å»ºåˆ†å‘åŒ…
- æµ‹è¯•ç‹¬ç«‹å®‰è£…

### Milestone 4: ä½“éªŒä¼˜åŒ– (Week 2-3)
- å®Œå–„ç”¨æˆ·å¼•å¯¼
- ä¼˜åŒ–é”™è¯¯å¤„ç†  
- æ€§èƒ½è°ƒä¼˜

## ğŸ”§ å¼€å‘ç¯å¢ƒå‡†å¤‡

```bash
# 1. ç”Ÿæˆè‡ªç­¾åè¯ä¹¦
./scripts/setup_signing.sh

# 2. é…ç½®æ„å»ºç¯å¢ƒ
./scripts/setup_build.sh

# 3. è¿è¡Œå®Œæ•´æµ‹è¯•
./scripts/test_full_flow.sh
```

---

**v2.0çš„æ ¸å¿ƒä»·å€¼**: å°†åº”ç”¨ä»"éœ€è¦æŠ€æœ¯çŸ¥è¯†çš„å¼€å‘å·¥å…·"è½¬å˜ä¸º"æ™®é€šç”¨æˆ·å¯ä»¥è½»æ¾ä½¿ç”¨çš„ç‹¬ç«‹åº”ç”¨"ã€‚